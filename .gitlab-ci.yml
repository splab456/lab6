image: maven:3.9.6-eclipse-temurin-17

variables:
  MAVEN_CLI_OPTS: "-B -e -V"

stages:
  - validate
  - test
  - package
  - integration-tests
  - coverage
  - deploy

maven-validate:
  stage: validate
  script:
    - mvn $MAVEN_CLI_OPTS validate

unit-tests:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS test
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/*.xml

package-app:
  stage: package
  script:
    - mvn $MAVEN_CLI_OPTS -DskipTests package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

integration-tests:
  stage: integration-tests
  script:
    - mvn $MAVEN_CLI_OPTS failsafe:integration-test failsafe:verify
  artifacts:
    when: always
    reports:
      junit: target/failsafe-reports/*.xml

coverage-report:
  stage: coverage
  script:
    - mvn $MAVEN_CLI_OPTS test jacoco:report
  artifacts:
    paths:
      - target/site/jacoco
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "Deploying application (configure real deployment here)..."
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
