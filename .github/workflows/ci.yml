name: Java CI – Lab6

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  validate:
    name: Maven validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run mvn validate
        run: mvn -B -e -V validate

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run mvn test
        run: mvn -B -e -V test

      - name: Upload surefire reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

  package:
    name: Package JAR
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build JAR (skip tests)
        run: mvn -B -e -V -DskipTests package

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  integration-tests:
    name: Integration tests (*IT.java)
    runs-on: ubuntu-latest
    needs: package

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run failsafe integration tests
        run: mvn -B -e -V failsafe:integration-test failsafe:verify

      - name: Upload failsafe reports
        uses: actions/upload-artifact@v4
        with:
          name: failsafe-reports
          path: target/failsafe-reports

  coverage:
    name: JaCoCo coverage
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run tests with JaCoCo
        run: mvn -B -e -V test jacoco:report

      - name: Upload JaCoCo HTML report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

  deploy:
    name: Dummy deploy
    runs-on: ubuntu-latest
    needs: [integration-tests, coverage]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Fake deploy step
        run: echo "Deploying application (lab work placeholder)…"
